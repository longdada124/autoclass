import streamlit as st
import pandas as pd
from datetime import datetime, timedelta
import re

st.set_page_config(page_title="å¾Œé¾åœ‹ä¸­-èª¿ä»£èª²æ™ºæ…§ç®¡ç†ç³»çµ±", layout="wide")

# å‡è¨­é€™æ˜¯ä¸€å€‹ç°¡æ˜“çš„è¡å ‚æª¢æŸ¥é‚è¼¯
def check_conflict(teacher_data, teacher_name, day, period):
    if teacher_name in teacher_data:
        if (day, period) in teacher_data[teacher_name]:
            return True, teacher_data[teacher_name][(day, period)]['class']
    return False, None

st.title("ğŸ“… èª¿ä»£èª²æ™ºæ…§ç®¡ç†èˆ‡é€šçŸ¥å–®ç”Ÿæˆ")

# --- å´é‚Šæ¬„ï¼šå»¶ç”¨ä¹‹å‰è®€å–çš„èª²è¡¨è³‡æ–™ ---
with st.sidebar:
    st.header("ğŸ“‹ åŸºç¤èª²è¡¨å°å…¥")
    st.info("è«‹ç¢ºèªå·²ä¸Šå‚³åŸå§‹èª²è¡¨èˆ‡é…èª²è³‡æ–™ï¼ˆç³»çµ±æœƒè‡ªå‹•é€£çµå‰ä¸€å€‹ç³»çµ±çš„æ•¸æ“šï¼‰")
    target_date = st.date_input("é¸æ“‡èª¿ä»£èª²æ—¥æœŸ", datetime.now())
    week_day = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "æ—¥"][target_date.weekday()]
    st.write(f"ç•¶å‰æ—¥æœŸç‚ºï¼šé€±{week_day}")

# --- ä¸»ç•«é¢ï¼šæ¨¡æ“¬èª¿ä»£èª²æ“ä½œ ---
if 'teacher_data' in st.session_state:
    col1, col2 = st.columns([1, 1])
    
    with col1:
        st.subheader("1. é¸æ“‡è«‹å‡/å—èª¿äºº")
        all_teachers = st.session_state.ordered_teachers
        absent_teacher = st.selectbox("è«‹å‡æˆ–æ¬²èª¿èª²è€å¸«", all_teachers)
        
        # é¡¯ç¤ºè©²å¸«ç•¶æ—¥èª²è¡¨
        st.write(f"ğŸ” {absent_teacher} è€å¸« é€±{week_day} çš„èª²ç¨‹ï¼š")
        day_num = target_date.weekday() + 1
        lessons = []
        for p in range(1, 9):
            info = st.session_state.teacher_data[absent_teacher].get((day_num, p), {})
            if info:
                lessons.append({"ç¯€æ¬¡": p, "ç­ç´š": info['class'], "ç§‘ç›®": info['subj']})
        
        if lessons:
            df_lessons = pd.DataFrame(lessons)
            selected_period = st.radio("é¸å–è¦è™•ç†çš„ç¯€æ¬¡", df_lessons['ç¯€æ¬¡'])
        else:
            st.warning("è©²è€å¸«æ­¤æ—¥ç„¡èª²ç¨‹ã€‚")

    with col2:
        st.subheader("2. å®‰æ’ä»£èª²æˆ–èª¿èª²")
        mode = st.radio("æ“ä½œæ¨¡å¼", ["ä»£èª² (æ‰¾äººè£œä½)", "èª¿èª² (å…©ç¯€äº’æ›)"])
        
        if mode == "ä»£èª² (æ‰¾äººè£œä½)":
            # æ™ºæ…§æ¨è–¦ï¼šæ‰¾å‡ºç•¶å‰ç¯€æ¬¡ç©ºå ‚çš„è€å¸«
            available_teachers = []
            for t in all_teachers:
                is_busy, _ = check_conflict(st.session_state.teacher_data, t, day_num, selected_period)
                if not is_busy:
                    available_teachers.append(t)
            
            sub_teacher = st.selectbox("é¸æ“‡ä»£èª²è€å¸« (å·²éæ¿¾ç©ºå ‚è€…)", available_teachers)
            st.success(f"âœ… å·²é¸å®šç”± {sub_teacher} è€å¸«ä»£èª²")
            
        else:
            st.write("è«‹é¸æ“‡èª¿èª²çš„ç›®æ¨™æ—¥æœŸèˆ‡ç¯€æ¬¡...")
            # é€™è£¡ä¹‹å¾Œæœƒå¯¦ä½œè·¨é€±äº’æ›é‚è¼¯

    # --- é€šçŸ¥å–®é è¦½èˆ‡ç”¢å‡º ---
    st.divider()
    if st.button("ğŸ–¨ï¸ ç”Ÿæˆèª¿ä»£èª²é€šçŸ¥å–®"):
        st.info("æ­£åœ¨å°‡ã€ä»£701 åœ‹æ–‡ã€å¯«å…¥ Word æ¨£æ¿æŒ‡å®šæ ¼ä½...")
        # é€™è£¡æœƒä¸²æ¥ master_replace é‚è¼¯åˆ°æ‚¨ä¸Šå‚³çš„ã€Œä»£èª¿èª²é€šçŸ¥å–®.docxã€
        st.success("é€šçŸ¥å–®ç”¢è£½æˆåŠŸï¼")

else:
    st.warning("è«‹å…ˆåœ¨ä¸»ç³»çµ±ä¸Šå‚³èª²è¡¨è³‡æ–™ï¼Œç³»çµ±æ‰èƒ½é€²è¡Œè¡å ‚æª¢æŸ¥ã€‚")
